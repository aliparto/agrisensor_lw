//******************************************************************************#include "Framework.h"#include "Common/Delay.h"#include "HardwareProfile.h"#include "GlobalVariables.h"//******************************************************************************#define COM_SELECT      UART2_SELECT//******************************************************************************#define SENSOR_COUNT                1Sensor mSensor[SENSOR_COUNT + 1];#define PACKET_LENGTH_RECEIVE       8     #define PACKET_LENGTH_SEND          64unsigned char ReceivedData[PACKET_LENGTH_RECEIVE + 1] = {'\0'};unsigned char SensorData[PACKET_LENGTH_SEND + 1] = {'\0'};//******************************************************************************#define AVERAGE_COUNT       5float fValueSoilMoisture = 0.0f;//******************************************************************************volatile char bTimeOut = 0;void __attribute__((__interrupt__, no_auto_psv)) _T1Interrupt(void) {    bTimeOut = 1;    _T1IF = 0;}void Initialize() {    InitIOs();    SerialCom_Init(COM_SELECT);}//******************************************************************************void InitIOs() {    ANSA = 0x00;    ANSB = 0x00;    LED_DEBUG_TRIS = 0;    LED_DEBUG = LED_OFF;}//******************************************************************************void Run() {    HandleCommunication();}//******************************************************************************char HeaderFooterIsOK(unsigned char* packet, int length) {    if (packet[0] == 0xFF && packet[1] == 0xAA) {        if (packet[length - 2] == 0x00 && packet[length - 1] == 0xBB) {            return 1;        }    }    return 0;}//******************************************************************************char CheckSumIsOK(unsigned char* packet, int length) {    int i = 0;    unsigned int cCheckSum = 0;    unsigned int rCheckSum = 0;    unsigned int b1 = 0;    unsigned int b2 = 0;    for (i = 2; i < (length - 2 - 2); ++i) {        cCheckSum += (unsigned char) packet[i];    }    b1 = (unsigned char) packet[length - 2 - 2];    b1 <<= 8;    b2 = (unsigned char) packet[length - 2 - 1];    b2 <<= 0;    rCheckSum = b1 | b2;    if (cCheckSum == rCheckSum)        return 1;    else        return 0;}//******************************************************************************void SetCheckSum(unsigned char* packet, int length) {    int i = 0;    unsigned int sum = 0;    for (i = 2; i < (length - 2 - 2); ++i) {        sum += (unsigned char) packet[i];    }    packet[length - 2 - 2] = (unsigned char) ((sum >> 8)&0xFF);    packet[length - 2 - 1] = (unsigned char) ((sum >> 0)&0xFF);}//******************************************************************************void HandleCommunication() {    if (SerialCom_GetFrame(COM_SELECT, (char*) ReceivedData, PACKET_LENGTH_RECEIVE)) {        if (HeaderFooterIsOK(ReceivedData, PACKET_LENGTH_RECEIVE)) {            if (CheckSumIsOK(ReceivedData, PACKET_LENGTH_RECEIVE)) {                switch (ReceivedData[2]) {                    case 'P':                    {                        DelayMs(10);                        SerialCom_WriteByLength(COM_SELECT, (char*) ReceivedData, PACKET_LENGTH_RECEIVE);                        DelayMs(250);                        LED_DEBUG = 1;                        ReadSensors();                        SendData();                        LED_DEBUG = 0;                    }                        break;                }            }        }    }}//******************************************************************************void ReadSensors() {    int i, iS = 0;    SoilMoisture_Init();    DelayMs(10);    fValueSoilMoisture = 0.0f;    for (i = 0; i < AVERAGE_COUNT; ++i) {        fValueSoilMoisture += (float) SoilMoisture_Read() / ((float) AVERAGE_COUNT);    }    iS = 0;    mSensor[iS].Status = 1;    mSensor[iS].ID = SensorType_SoilMoisture;    mSensor[iS].Type = SensorType_SoilMoisture;    mSensor[iS].Value = fValueSoilMoisture;}//******************************************************************************void SendData() {    SensorData[0] = 0xFF;    SensorData[1] = 0xAA;    SensorData[PACKET_LENGTH_SEND - 2] = 0x00;    SensorData[PACKET_LENGTH_SEND - 1] = 0xBB;    int pos = 2;    SensorData[pos++] = SENSOR_COUNT;    SensorData[pos++] = 0x00;    SensorData[pos++] = 0x00;    SensorData[pos++] = 0x00;    int iS = 0;    for (iS = 0; iS < SENSOR_COUNT; ++iS) {        SensorData[pos++] = mSensor[iS].Status;        SensorData[pos++] = mSensor[iS].ID;        SensorData[pos++] = mSensor[iS].Type;        char* pValue = (char*) &mSensor[iS].Value;        SensorData[pos++] = pValue[0];        SensorData[pos++] = pValue[1];        SensorData[pos++] = pValue[2];        SensorData[pos++] = pValue[3];    }    SetCheckSum(SensorData, PACKET_LENGTH_SEND);    SerialCom_WriteByLength(COM_SELECT, (char *) SensorData, PACKET_LENGTH_SEND);}//******************************************************************************